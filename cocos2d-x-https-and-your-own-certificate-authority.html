<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="Description" content="A blog about indie mobile MMO game development.">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Cocos2d-x HTTPS and your own certificate authority</title>

        <!-- Bootstrap -->
        <style>
            @font-face{font-family:'Merriweather';font-style:normal;font-weight:400;src:local('Merriweather'),url(http://themes.googleusercontent.com/static/fonts/merriweather/v6/RFda8w1V0eDZheqfcyQ4EKRDOzjiPcYnFooOUGCOsRk.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;src:local('Merriweather Bold'),local('Merriweather-Bold'),url(http://themes.googleusercontent.com/static/fonts/merriweather/v6/ZvcMqxEwPfh2qDWBPxn6nhAPw1J91axKNXP_-QX9CC8.woff) format('woff')}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:400;src:url(http://themes.googleusercontent.com/static/fonts/merriweathersans/v3/AKu1CjQ4qnV8MUltkAX3sM2kigAIKUS7C8wDj9A45hI.ttf) format('truetype')}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:800;src:url(http://themes.googleusercontent.com/static/fonts/merriweathersans/v3/6LmGj5dOJopQKEkt88Gowf5_oG7m85YQnBYEZ7uTa3L3rGVtsTkPsbDajuO5ueQw.ttf) format('truetype')}body{font-family:Merriweather,serif!important;color:#333;background:#fdfdfd;text-rendering:optimizeLegibility!important;font-size:14px!important;margin:0}h2,h3,h4{font-family:'Merriweather Sans',sans-serif!important;font-weight:bold!important;text-align:center}h2{font-size:32px!important;line-height:1.56em!important}#posts h2{font-size:24px!important;line-height:1.55;text-align:left}a{text-decoration:none}#header_status{background:#000;line-height:40px;color:#d3d4d5}#nav{float:right}#nav a{color:#a3a3a3;padding:0 0 0 15px}.sans{font-family:'Merriweather Sans',sans-serif!important}@media(min-width:993px){#posts li{width:405px}#posts .col_1{margin-right:90px}}@media(max-width:767px){.container{padding:0 15px!important}#logo{width:300px;background:url("/images/logo_background.png") no-repeat;background-size:contain;background-position:0 8px}}@media(min-width:768px){.container{max-width:960px!important;padding:0 30px!important}#logo{width:366px;background:url("/images/logo_background.png");background-size:cover}}#logo{height:130px;margin:0 auto;color:#e7e7e7;font-family:'Merriweather Sans';font-weight:bold;text-align:center;line-height:130px;font-size:48px;text-shadow:1px 1px #333}#logo_link{text-decoration:none}#header{background:#233556;height:195px}#header .container{padding:32px 0 0 0!important}#social_header{background:#666377;height:60px;line-height:60px;color:#e7e7e7;text-align:right;color:#e7e7e7;text-align:right}.post_link{color:#333}.twitter_link{color:#e7e7e7;text-decoration:none}.twitter_link span{color:#3a88f0;font-weight:bold}p{line-height:1.8em;margin-top:1.8em!important;margin-bottom:1.8em!important}.date{text-align:center;font-size:14px;color:#a3a3a3;margin-top:0}#posts{list-style-type:none}.container{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:768px){.container{width:750px}}@media(min-width:992px){.container{width:970px}}@media(min-width:1200px){.container{width:1170px}}.container:before,.container:after{display:table;content:" "}.container:after{clear:both}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}*:before,*:after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}#rss_link{padding:20px 20px 20px 0;text-decoration:none;font-weight:bold}#rss_link img{text-decoration:none}#rss_link span{margin-left:10px;font-family:'Merriweather Sans',sans-serif;color:#333}#rss_wrapper{display:inline;line-height:60px;height:auto;vertical-align:middle;margin-left:36px}#rss_button{position:relative;display:inline-block;line-height:60px;height:26px;width:24px;vertical-align:middle}#rss_button div{width:24px;height:24px;background:url("/images/rss_button_sprite.png");background-position:0 0}#posts li{float:left;margin-top:30px}.#posts content{padding-left:0}#posts .date{text-align:left}#posts .post_header{text-align:left}#posts{margin:0;padding:0}
        </style>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <!-- Main page -->
        <div id="header_status">
            <div class="container">
                    A blog about indie mobile MMO game development.
                    <div id="nav" class="sans">
                        <a href="/">Home</a>
                    </div>
            </div>
        </div>
        <div id="header">
            <div class="container">
                <a href="/" id="logo_link">
                    <div id="logo">
                        <div id="logo_text">CATCHVAR</div>
                    </div>
                </a>
            </div>
        </div>
        <div id="social_header">
            <div class="container">
                <a class="twitter_link" href="https://twitter.com/intent/follow?original_referer=http%3A%2F%2Fcatchvar.com%2F&region=follow_link&screen_name=catchvar&tw_p=followbutton&variant=2.0">Follow me on <span class="sans">TWITTER</span></a>
                <span id="rss_wrapper">
                    <a id="rss_button" href="/feed/index.xml"><div></div></a>
                </span>
            </div>
        </div>

        <div class="container">
            <div class="content">
                <div id="post_content">

<p class="post_header">
    <a href="/cocos2d-x-https-and-your-own-certificate-authority.html">
        <img src="/images/cocos2d_x_https_and_your_own_certificate_authority.png" alt="cocos2d-x https and creating your own certificate authority image"/>
    </a>
</p>

<p><a class="post_link" href="/cocos2d-x-https-and-your-own-certificate-authority.html"></p>

<h2>Cocos2d-x HTTPS and your own certificate authority</h2>

<p></a></p>

<p class="date">
    Mar 25, 2014
</p>

<p>Security in mobile games is usually left by the wayside. Usually, it&#39;s just the lowest priority item on the list when it comes to getting a game out by a deadline. After the fact, you can ask anyone if the game should have security feature X and they&#39;ll be shocked that it doesn&#39;t already exist. Ask the same person before a deadline if you should have the same security feature, or a sparkling unicorn riding across the bottom of the settings page, and they&#39;ll choose the sparking unicorn unless they&#39;re a security nut.</p>

<!--***-->

<p>This isn&#39;t always entirely without merit. However, in the context of a real-time multiplayer game where players constantly interact with each other security becomes more important. You don&#39;t want one bad seed ruining the experience for all the other players. Using HTTPS is one aspect that can improve the security of your game. We don&#39;t need to buy an expensive certificate from a certificate authority either. If you&#39;re distributing a mobile game you can distribute the certificate chain with the game.</p>

<h3>Create your own certificate authority</h3>

<p>This is the part that I had the most trouble with. There are tutorials galore out there, however the ones I ran into failed to provide certificates that actually worked. Hopefully it can be a little easier for you. Use <a href="https://github.com/jsermeno/easycert_openssl.git">easycert openssl</a> on github to create your certificates.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>curl -O https://raw.github.com/jsermeno/kerl/master/easycert
<span class="nv">$ </span>chmod a+x easycert
</code></pre></div>
<p>Then add this file to your path. You can edit your <code>~/.bash_profile</code> and do something like this:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:~/Workspace/path/easycert
</code></pre></div>
<p>Next we&#39;ll create a necessary configuration file. Make any necessary changes to the following config and copy it into your shell.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>cat &gt; ~/.easycertrc <span class="s">&lt;&lt; EOF</span>
<span class="s">EASYCERT_COUNTRY=&quot;US&quot;</span>
<span class="s">EASYCERT_STATE=&quot;California&quot;</span>
<span class="s">EASYCERT_LOCALITY=&quot;Mountain View&quot;</span>
<span class="s">EASYCERT_ORGANIZATION=&quot;Catchvar&quot;</span>
<span class="s">EASYCERT_UNIT=&quot;Studio&quot;</span>
<span class="s">EASYCERT_COMMON_NAME=&quot;localhost&quot;</span>
<span class="s">EASYCERT_EMAIL=&quot;youremailaddress@gmail.com&quot;</span>
<span class="s">EASYCERT_UNSTRUCTURED=&quot;Catchvar&quot;</span>
<span class="s">EOF</span>
</code></pre></div>
<p>When a client makes a request it will check the domain against the <code>EASYCERT_COMMON_NAME</code> property so make sure this property reflects your own domain. For development, localhost works. You&#39;ll need seperate certificates for production. The other important property is <code>EASYCERT_ORGANIZATION</code>. You just need to know that this must be the same among all your certificates. Easycert will do that for you, so don&#39;t worry.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>easycert create-all ~/.ca
</code></pre></div>
<p>This command tells easycert to create your certificates at <code>~/.ca</code>. It will create a root certificate, an intermediate certificate, and a server certificate. The root certificate and the intermediate certificate make up the certificate chain. The certificate chain will be what clients use to verify your server. </p>

<p>You&#39;ll be prompted several times during this process. You&#39;ll be asked for two separate passphrases for the root and intermediate keys. You will need to enter each passpharse twice to verify that it&#39;s really what you wanted to enter.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">Generating directory structure... /Users/catchvar/.cert
Generating directory structure... /Users/catchvar/.cert/intermediate
Generating ca root key...
Generating RSA private key, 4096 bit long modulus
................................................................................................................................................................++
.....................................................................................................++
e is 65537 <span class="o">(</span>0x10001<span class="o">)</span>
Enter pass phrase <span class="k">for</span> /Users/catchvar/.cert/private/ca.key.pem:
Verifying - Enter pass phrase <span class="k">for</span> /Users/catchvar/.cert/private/ca.key.pem:
</code></pre></div>
<p>When generating the certificates you&#39;ll need to re-enter these passphrases.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">Enter pass phrase <span class="k">for</span> /Users/catchvar/.cert/private/ca.key.pem:
</code></pre></div>
<p>Then you&#39;ll be asked to confirm the certificate info. The defaults will be what you entered into the configuration above. If you want to use the defaults just press enter and quickly get through that section.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
-----
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>US<span class="o">]</span>:
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>California<span class="o">]</span>:
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>Mountain View<span class="o">]</span>:
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Catchvar<span class="o">]</span>:
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>Studio<span class="o">]</span>:
Common Name <span class="o">(</span>eg, YOUR name<span class="o">)</span> <span class="o">[</span>localhost<span class="o">]</span>:
Email Address <span class="o">[</span>youremailaddress@gmail.com<span class="o">]</span>:
generating intermediate key...
Generating RSA private key, 4096 bit long modulus
.......................++
...........................++
e is 65537 <span class="o">(</span>0x10001<span class="o">)</span>
</code></pre></div>
<p>You&#39;ll need to to the same serveral times. Once for each certificate that is generated. When asked if you want to sign the certificate and commit just type <code>y</code>. The end will look like this.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">1 out of 1 certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
Write out database with 1 new entries
Data Base Updated
Verifying server certificate...<span class="o">{}</span>
/Users/jsermeno/.cert/intermediate/certs/localhost.cert.pem: OK
<span class="k">done</span>.
</code></pre></div>
<p>Now you can get the paths for where your certificates are stored.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>easycert find ~/.ca
ca:                /Users/catchvar/.ca/certs/ca.cert.pem
intermediate:      /Users/catchvar/.ca/intermediate/certs/intermediate.cert.pem
server key:        /Users/catchvar/.ca/intermediate/private/localhost.key.pem
server:            /Users/catchvar/.ca/intermediate/certs/localhost.cert.pem
ca-chain:          /Users/catchvar/.ca/intermediate/certs/ca-chain.cert.pem
<span class="k">done</span>.
</code></pre></div>
<p>Easycert verifies your certificates, but for added measure you can verify that your certificates are working properly with the following command.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">openssl verify -verbose -purpose sslserver -CAfile ~/.ca/intermediate/certs/ca-chain.cert.pem ~/.ca/intermediate/certs/localhost.cert.pem
</code></pre></div>
<h3>Use HTTPS with cocos2d-x</h3>

<p>Currently I&#39;m using cocos2d-x-3.0rc0. The version of libcurl included is 7.27.0 and is built with openssl. Beware. Newer versions of libcurl may be built with darwinssl, which is Apple&#39;s native Secure Transport. This could be good. It means that you don&#39;t have to include openssl. That means saving on the precious app size. However those versions of libcurl use the keychain on iOS and ignore the <code>CURLOPT_CAINFO</code> option. That means you can&#39;t specify your own root certificate without using Apple&#39;s APIs for adding certificates to the keychain. </p>

<p>To check what version of openssl you have you can use the following code.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="n">curl</span> <span class="o">=</span> <span class="n">curl_easy_init</span><span class="p">();</span>

<span class="n">curl_version_info_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">curl_version_info</span><span class="p">(</span><span class="n">CURLVERSION_NOW</span><span class="p">);</span>
<span class="n">cocos2d</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;openssl version: %s&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ssl_version</span><span class="p">);</span>
<span class="n">cocos2d</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;version: %s&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
</code></pre></div>
<p>Add <code>ca-chain.cert.pem</code> to your resources directory. I added mine at <code>Project/ca-chain.cert.pem</code>. The easiest way to make a HTTP request with cocos2d-x is to look at the samples and use the HttpClient class. Unfortunately, the HttpClient class does not currently support ssl. In fact it turns off ssl verification so that you can make requests to a https url with no certificate bundle. This certainly, is not secure.</p>

<p>Fortunately, it&#39;s easy to add this functionality to HttpClient. In HttpClient.h add these lines under the public method section.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="cm">/** Enable ssl support **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enableSSLCaInfo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">info</span><span class="p">);</span>

<span class="cm">/** Disable ssl support **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disableSSLCaInfo</span><span class="p">();</span>
</code></pre></div>
<p>In HttpClient.cpp we&#39;ll add a string representing the path to your <code>ca-chain.cert.pem</code> file.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s_sslCaInfo</span><span class="p">;</span> <span class="c1">// string path to CURL_CAINFO value</span>

<span class="n">And</span> <span class="n">the</span> <span class="n">methods</span> <span class="k">for</span> <span class="n">changing</span> <span class="k">this</span> <span class="n">string</span><span class="p">.</span>

<span class="kt">void</span> <span class="n">HttpClient</span><span class="o">::</span><span class="n">enableSSLCaInfo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">s_sslCaInfo</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">HttpClient</span><span class="o">::</span><span class="n">disableSSLCaInfo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">s_sslCaInfo</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>In the method <code>configureCURL</code> you&#39;ll find these lines.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
<span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
</code></pre></div>
<p>These lines disable ssl verification. Change them to these lines.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="k">if</span> <span class="p">(</span><span class="n">s_sslCaInfo</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="mi">1L</span><span class="p">);</span>
    <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="mi">2L</span><span class="p">);</span>
    <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CURLOPT_CAINFO</span><span class="p">,</span> <span class="n">s_sslCaInfo</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p>This just says that if you set the s_sslCaInfo string then enable ssl verification and look for the certificate chain at this location. I&#39;ve added a pull request for this in the latest cocos2d-x develop. Hopefully, it or some variant gets merged in after review. The alternative is to use curl manually to do your requests for ssl. This isn&#39;t terrible, but why do that when HttpClient already offers so much functionality?</p>

<h3>Make a Request</h3>

<p>You can use the HttpClient to make a request from any class, but it needs to inherit from <code>cocos2d::Layer</code>.</p>

<p>In your header file include the following headers.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;iostream&gt; </span><span class="c1">// optional</span>
<span class="cp">#include &quot;cocos2d.h&quot;</span>
<span class="cp">#include &quot;network/HttpClient.h&quot;</span>
<span class="cp">#include &quot;msgpack.hpp&quot; </span><span class="c1">// optional</span>
<span class="cp">#include &quot;CCConsole.h&quot; </span><span class="c1">// optional</span>
</code></pre></div>
<p>Add a public definition like the following.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="k">class</span> <span class="nc">YourClass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">Layer</span> <span class="p">{</span>
<span class="nl">public:</span>

    <span class="kt">void</span> <span class="n">onCallback</span><span class="p">(</span><span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpClient</span> <span class="o">*</span><span class="n">sender</span><span class="p">,</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">);</span>
</code></pre></div>
<p>In your cpp file include the following headers and using declarations.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="cp">#include &quot;HttpRequest.h&quot;</span>

<span class="n">USING_NS_CC</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="p">;</span>
</code></pre></div>
<p>Now you need to enable ssl. This is where you specify the filepath to your cert. In order to get this to work on both iOS and android a little trickery is involved. I haven&#39;t found a better solution as of yet. Warning: Not nice solution ahead.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="k">auto</span> <span class="n">sharedFileUtils</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ret</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">CC_TARGET_PLATFORM</span> <span class="o">==</span> <span class="n">CC_PLATFORM_ANDROID</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">writablePath</span> <span class="o">=</span> <span class="n">sharedFileUtils</span><span class="o">-&gt;</span><span class="n">getWritablePath</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writablePath</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">writablePath</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">writablePath</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;app_data/ca-chain.cert.pem&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">sharedFileUtils</span><span class="o">-&gt;</span><span class="n">fullPathForFilename</span><span class="p">(</span><span class="s">&quot;ca-chain.cert.pem&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpClient</span><span class="o">::</span><span class="n">enableSSLCaInfo</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</code></pre></div>
<p>The reason for this code is that on iOS we can give curl a path from our Resources directory no problem. When libcurl opens the cert file it first calls into openssl, then eventually uses <code>fopen</code> to open the cert. Since on android our Resources directory will be inside the APK, it is inaccessible. This means we need to store our cert in our application data folder. This is internal storage that is allocated for each app. The path above will point to the correct place. But, you need to copy your cert from the Assets (Resources on android) folder to the application data folder. This can be done in the <code>onCreate</code> method of your Activity.</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// TODO Auto-generated method stub</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">InputStream</span> <span class="n">ims</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">AssetManager</span> <span class="n">assets</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getAssets</span><span class="o">();</span>

            <span class="n">File</span> <span class="n">path</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&quot;data&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">File</span> <span class="n">certFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">&quot;ca-chain.pem&quot;</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">certFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">os</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">certFile</span><span class="o">);</span>
                <span class="n">ims</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s">&quot;ca-chain.pem&quot;</span><span class="o">);</span>
                <span class="n">certFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>

                <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>

                <span class="k">while</span> <span class="o">((</span><span class="n">read</span> <span class="o">=</span> <span class="n">ims</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">read</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;cocos2d-x&quot;</span><span class="o">,</span> <span class="s">&quot;Failed to create data cert!&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">ims</span><span class="o">);</span>
            <span class="n">close</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>
        <span class="o">}</span>

<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">Closeable</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;cocos2d-x&quot;</span><span class="o">,</span> <span class="s">&quot;Failed to close closeable.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Setup the request.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpRequest</span><span class="p">();</span>
<span class="n">request</span><span class="o">-&gt;</span><span class="n">setUrl</span><span class="p">(</span><span class="s">&quot;https://localhost:8443&quot;</span><span class="p">);</span>
<span class="n">request</span><span class="o">-&gt;</span><span class="n">setRequestType</span><span class="p">(</span><span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">POST</span><span class="p">);</span>
<span class="n">request</span><span class="o">-&gt;</span><span class="n">setResponseCallback</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">httpresponse_selector</span><span class="p">(</span><span class="n">YourClass</span><span class="o">::</span><span class="n">onCallback</span><span class="p">));</span>
</code></pre></div>
<p>My project uses <a href="http://msgpack.org/">MessagePack</a> to post data. But any <code>(char *)</code> can be sent.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">postData</span><span class="p">;</span>
<span class="n">postData</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;dataOne&quot;</span><span class="p">);</span>
<span class="n">postData</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;dataTwo&quot;</span><span class="p">);</span>

<span class="c1">// msgpack data</span>
<span class="n">msgpack</span><span class="o">::</span><span class="n">sbuffer</span> <span class="n">sbuf</span><span class="p">;</span>
<span class="n">msgpack</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbuf</span><span class="p">,</span> <span class="n">postData</span><span class="p">);</span>
</code></pre></div>
<p>Now you can set the data and send!</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="n">request</span><span class="o">-&gt;</span><span class="n">setRequestData</span><span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="n">cocos2d</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">HttpClient</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="n">request</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</code></pre></div>
<p>Just wait for your response.</p>
<div class="highlight"><pre><code class="c++ language-c++" data-lang="c++"><span class="kt">void</span> <span class="n">YourClass</span><span class="o">::</span><span class="n">onCallback</span><span class="p">(</span><span class="n">HttpClient</span> <span class="o">*</span><span class="n">sender</span><span class="p">,</span> <span class="n">HttpResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cocos2d</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="n">no</span> <span class="n">response</span><span class="p">.</span><span class="s">&quot;);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">isSucceed</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cocos2d</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;response failed.&quot;</span><span class="p">);</span>
        <span class="n">cocos2d</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;error buffer: %s&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">getErrorBuffer</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">getResponseData</span><span class="p">();</span>
    <span class="n">msgpack</span><span class="o">::</span><span class="n">unpacked</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">msgpack</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
    <span class="n">msgpack</span><span class="o">::</span><span class="n">object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">parsedResponse</span><span class="p">;</span>
    <span class="n">obj</span><span class="p">.</span><span class="n">convert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parsedResponse</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>If you used MessagePack your data is in the parsedResponse vector. Otherwise your response will be in the buffer vector as a series of chars.</p>

<p>Hopefully, this post will make someone&#39;s game more secure. You can double check that everything is working by creating a second set of certificates. Use that set of certificates on your server and when you try using the ca-chain cert from the first set you should get an error.</p>

<p><strong>Disclaimer</strong>: I am not a security expert, just a security-conscious everything engineer. Use at your own risk.</p>

<p><strong>P.S.</strong> If you do not want to create your own certificate authority, and just want to access <code>https://www.google.com</code>, you can use the ca bundle provided from the <a href="http://curl.haxx.se/docs/caextract.html">curl website</a>. <a href="http://curl.haxx.se/ca/cacert.pem">Here</a> is where you can download <code>cacert.pem</code>. This bundle is converted from Mozilla&#39;s CA cert bundle.</p>

</div>

<div class="share_buttons">
  <script type="IN/Share" data-url="http://catchvar.com/cocos2d-x-https-and-your-own-certificate-authority.html" data-counter="right"></script>

  <a href="https://twitter.com/share"
    class="twitter-share-button"
    data-url="http://catchvar.com/cocos2d-x-https-and-your-own-certificate-authority.html"
    data-via="twitterapi"
    data-lang="en">
  </a>

  <div class="google_plus">
    <div class="g-plusone"
      data-href="http://catchvar.com/cocos2d-x-https-and-your-own-certificate-authority.html"
      data-size="medium"
      data-annotation="bubble">
    </div>
  </div>

  <div class="fb-like" 
    data-href="http://catchvar.com/cocos2d-x-https-and-your-own-certificate-authority.html" 
    data-layout="button_count" 
    data-action="like" 
    data-show-faces="false" 
    data-width="90"
    data-share="false">
  </div>
</div>


<p class="bottom"></p>



<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'catchvar'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=604216856328704";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script type="text/javascript">
(function(){
    var twitterWidgets = document.createElement('script');
    twitterWidgets.type = 'text/javascript';
    twitterWidgets.async = true;
    twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
    document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
</script>

<script type="text/javascript">
(function() {
    var po = document.createElement('script');
    po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(po, s);
})();
</script>

<script src="//platform.linkedin.com/in.js" type="text/javascript">
  lang: en_US
</script>


            </div>
        </div>

        <div class="container">
            <div id="email_subscriber">
                <h2>Subscribe For Updates</h2>
                <!-- Begin MailChimp Signup Form -->
                <div id="mc_embed_signup">
                    <form action="http://catchvar.us8.list-manage1.com/subscribe/post?u=6bf07ccd5886d281ddf64cda3&amp;id=d90439d3b9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>

                        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>

                        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                        <div style="position: absolute; left: -5000px;">
                            <input type="text" name="b_6bf07ccd5886d281ddf64cda3_d90439d3b9" value="">
                        </div>

                        <input type="submit" value="Join the list" name="subscribe" id="mc-embedded-subscribe" class="button">
                    </form>
                </div>
                <!--End mc_embed_signup-->
            </div>
        </div>

        <div id="footer">
        </div>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-48849049-1', 'catchvar.com');
            ga('send', 'pageview');

        </script>

        <link href="css/201404042135.min.css" rel="stylesheet" />
        <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
    </body>
</html>
